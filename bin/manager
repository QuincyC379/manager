#!/bin/bash
PACKAGE="$WORKSPACE/auto_deploy/795/package"
HELP_BASE="*************************************************************************\n
manager build|deploy|tomcat|logs|cleanlogs|help                              \t\t\t*\n\t
        build     \t\t代码更新、打包、部署                                    \t\t\t\t*\n\t
        deploy    \t自动部署$PACKAGE 下的包                                        \t*\n\t
        tomcat    \t重启、停止tomcat                                         \t\t\t\t*\n\t
        logs      \t\t查看catalina.out最新200行                                \t\t\t*\n\t
        cleanlogs \t清除日志并重启tomcat                                      \t\t\t\t*\n\t
        help      \t\t帮助                                               \t\t\t\t\t\t*\n
************************************************************************\t"
HELP_ADVA="*************************************************************************\n
manager -m init|create|delete|help                                       \t\t\t\t\t*\n\t
        -m init   \t初始化设置(source $HOME/.bashrc生效)                           \t*\n\t
        -m create \t新增应用初始化                                          \t\t\t\t\t*\n\t
        -m delete \t删除应用                                               \t\t\t\t\t*\n\t
        -m help   \t帮助                                                \t\t\t\t\t\t*\n
************************************************************************\t"

INITSH="
_parser_options()\n
{\n
   local curr_arg;\n
   curr_arg=\${COMP_WORDS[COMP_CWORD]}\n
   param=\`manager -m complete|sed 's#|# #g'\`\n
   COMPREPLY=(\$(compgen -W \"\$param\" -- \$curr_arg ))\n
}\n
complete -F _parser_options manager"

####以下变量全局唯一,如无必要请一定不修改
export USERNAME=znm   #用户名
export LANG=zh.CN.UTF-8
export WORKSPACE=/export #工作空间
export SHELL=$WORKSPACE/Shell #执行脚本位置
export WORK=$WORKSPACE/Work #工作WAR包位置
export SOURCE=$WORKSPACE/Source #代码保存位置
export INSTANCE=$WORKSPACE/Instance #catalina_base位置
export LOGS=$WORKSPACE/Logs #日志保存位置
export NGINX=$WORKSPACE/Nginx #nginx位置

SELECT()
{
    echo "输入选择的id:"
    select SELECT in $1; do
      case ${SELECT} in "")echo Re-select;; *) break;; esac
    done
    echo ""
}

ADDENV()
{
    mkdir -p $SHELL/$DOMAIN/
    cp ../env.sh $SHELL/$DOMAIN/
    chmod u+x $SHELL/$DOMAIN/env.sh
    echo "===== 已配置env.sh脚本 ====="
}



cd `dirname $0`
#切换到指定用户
if [[ "$USERNAME" != `whoami` ]];then
    echo "当前用户不是$USERNAME, 进行切换..."
    su - $USERNAME
fi

########################### 基础管理 #######################################
case $1 in
    build)
        echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
        $SHELL/$DOMAIN/build
        ;;
    deploy)
        echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
        echo -n "从以下war包中," && SELECT `ls ${PACKAGE}` && WAR=${SELECT}
        echo "domain = $DOMAIN, war = $WAR"
        read -p "Are you sure deploy ?(yes/no):" YES
        case $YES in
            y|Y|yes|YES)
                echo "======= deploy start! ======="
                $SHELL/$DOMAIN/tomcat stop
                rm -rf $WORK/$DOMAIN/*
                unzip $PACKAGE/$WAR -d $WORK/$DOMAIN/
                chmod -R +wrx $WORK/$DOMAIN/*
                $SHELL/$DOMAIN/tomcat
        esac
        ;;
    tomcat)
        echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
        select COM in "restart" "stop";do
            case $COM in "")echo Re-select;; restart)$SHELL/$DOMAIN/tomcat restart;break;;
                stop)$SHELL/$DOMAIN/tomcat stop;break;;esac
        done
        ;;
    logs)
        echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
        tail -200f $INSTANCE/$DOMAIN/server1/logs/catalina.out
        ;;
    cleanlogs)
        echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
        echo "delete the following files:"
        find $INSTANCE/$DOMAIN/server?/logs/ -type f;
        find $LOGS/$DOMAIN/* -type f -name '*.log*'|egrep "*.log$|*.log(\\.)?[0-9]+";
        read -p "Are you sure detele all logs?(yes/no):" YES
        case $YES in
            y|Y|yes|YES)
            find $INSTANCE/$DOMAIN/server?/logs/ -type f|xargs rm -f;
            find $LOGS/$DOMAIN/* -type f -name '*.log*'|egrep "*.log$|*.log(\\.)?[0-9]+"|xargs rm -f;
            echo "All delete completed !"
            $SHELL/$DOMAIN/tomcat
        esac
        ;;
    [a-zA-Z0-9]*|"")
        echo -e ${HELP_BASE}
        ;;
esac



########################### 高级管理 #######################################
if [[ $1 != "-m" ]];then
    exit 0
fi
case $2 in
    init)
        MANAGER_HOME=`pwd`
        find ../ -name "*.sh"|xargs chmod u+x
        if [ `cat ${HOME}/.bashrc|grep ":${MANAGER_HOME}"|wc -l` == 0 ]; then
            echo -e "export PATH=\$PATH:${MANAGER_HOME}\n" ${INITSH} >> $HOME/.bashrc
            echo "已添加环境变量，请重新打开bash或者 source ~/.bashrc生效"
        fi
        echo "===== 已初始化完成 ====="
        ;;
    create)
        echo -n "从以下操作中," && SELECT "add-build add-tomcat+nginx add-build+tomcat+nginx add-home" && OPERATE=${SELECT}
        case ${OPERATE} in
        add-build)
            read -p "请输入域名:" DOMAIN
            ADDENV
            ../build/add-build.sh $DOMAIN
            $SHELL/$DOMAIN/build
            ;;
        add-tomcat+nginx)
            read -p "请输入域名:" DOMAIN
            ADDENV
            ../deploy/add-nginx+tomcat.sh $DOMAIN
            ;;
        add-build+tomcat+nginx)
            read -p "请输入域名:" DOMAIN
            ADDENV
            ../deploy/add-nginx+tomcat.sh $DOMAIN

            ../build/add-build.sh $DOMAIN
            $SHELL/$DOMAIN/build
            $S
            ;;
        add-home)
            echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
            mkdir -p ${WORKSPACE}/home/${DOMAIN}
            cd ${WORKSPACE}/home/${DOMAIN}
            ln -sf ${SHELL}/${DOMAIN}/* .
            ln -sf ${INSTANCE}/${DOMAIN}/server./logs/catalina.out .
            ln -sf ${LOGS}/${DOMAIN} Logs
            ln -sf ${SOURCE}/$DOMAIN .
            echo "已配置${DOMAIN}的home目录"
            ;;
        esac
        ;;
    delete)
        echo -n "从以下操作中," && SELECT "del-build del-tomcat+nginx del-build+tomcat+nginx del-home" && OPERATE=${SELECT}
        case ${OPERATE} in
        del-build)
            echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
            ../build/rm-build.sh $DOMAIN
            ;;
        del-tomcat+nginx)
            echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
            ../deploy/rm-nginx+tomcat.sh $DOMAIN
            ;;
        del-build+tomcat+nginx)
            echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
            ../build/rm-build.sh $DOMAIN
            ../deploy/rm-nginx+tomcat.sh $DOMAIN
            ;;
        del-home)
            echo -n "从以下域名中," && SELECT `ls ${SHELL}` && DOMAIN=${SELECT}
            rm -rf ${WORKSPACE}/home/${DOMAIN}
            ;;
        esac
        ;;
    "complete")
        cpbase=`echo -e $HELP_BASE|sed -n 2p|awk '{print $2}'`
        cpadva=`echo -e $HELP_ADVA|sed -n 2p|awk '{print $3}'`
        echo ${cpbase}"|"${cpadva}
        ;;
    *)
        echo -e ${HELP_ADVA}
        ;;
esac